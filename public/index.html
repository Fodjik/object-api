<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Object Storage App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    nav { margin-bottom: 20px; }
    nav button { margin-right: 10px; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    label { display: block; margin-top: 10px; }
    .action-btn { margin-right: 5px; cursor: pointer; }
    #qr-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; }
    .error { color: red; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showPage('new-or-edit-object')" id="new-object-btn">New Object</button>
    <button onclick="showPage('storage')">Storage</button>
    <button onclick="showPage('login')">Login</button>
    <button onclick="showPage('register')">Register</button>
    <span id="user-status"></span>
  </nav>

  <!-- New/Edit Object Page -->
  <div id="new-or-edit-object" class="hidden">
    <h2 id="form-title">Create New Object</h2>
    <form id="object-form">
      <input type="hidden" id="edit-id" />
      <label>Name: <input type="text" id="name" required /></label>
      <label>Length (cm): <input type="text" id="length" required /></label>
      <label>Width (cm): <input type="text" id="width" required /></label>
      <label>Depth (cm): <input type="text" id="depth" required /></label>
      <label>Surface: <input type="text" id="surface" required /></label>
      <label>Storage Location:
        <select id="location" required>
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
        </select>
      </label>
      <p id="form-error" class="error hidden"></p>
      <button type="submit">Save Object</button>
    </form>
  </div>

  <!-- Storage Page -->
  <div id="storage" class="hidden">
    <h2>Storage</h2>
    <label>Filter by name: <input type="text" id="filter-name" oninput="renderObjects()" /></label>
    <label>Filter by location:
      <select id="filter-location" onchange="renderObjects()">
        <option value="">All</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
      </select>
    </label>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Length</th>
          <th>Width</th>
          <th>Depth</th>
          <th>Surface</th>
          <th>Location</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="object-table"></tbody>
    </table>
  </div>

  <!-- QR Code Modal -->
  <div id="qr-modal" class="hidden">
    <h3>QR Code</h3>
    <div id="qrcode"></div>
    <button onclick="downloadQRCode()">Download QR as PNG</button>
    <button onclick="downloadQRCodeAsPDF()">Download QR as PDF</button>
    <button onclick="closeQRModal()">Close</button>
  </div>

<script>
  const BASE_URL = 'https://object-api-j9uw.onrender.com';

  // Initialize Supabase (use direct import for simplicity)
  const { createClient } = window['@supabase/supabase-js'];
  const supabase = createClient('https://your-project.supabase.co', 'your-anon-key'); // Replace with your credentials

  document.addEventListener('DOMContentLoaded', () => {
    checkAuthStatus();
    attachEventListeners();
    renderObjects();
  });

  async function checkAuthStatus() {
    const { data: { user } } = await supabase.auth.getUser();
    const userStatus = document.getElementById('user-status');
    const newObjectBtn = document.getElementById('new-object-btn');
    if (user) {
      userStatus.textContent = `Logged in as ${user.email} (Logout)`;
      userStatus.onclick = () => supabase.auth.signOut().then(() => location.reload());
      newObjectBtn.disabled = false;
    } else {
      userStatus.textContent = 'Not logged in';
      newObjectBtn.disabled = true;
    }
  }

  function attachEventListeners() {
    const form = document.getElementById('object-form');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorElement = document.getElementById('form-error');
        const id = document.getElementById('edit-id').value;
        const length = document.getElementById('length').value.replace(',', '.');
        const width = document.getElementById('width').value.replace(',', '.');
        const depth = document.getElementById('depth').value.replace(',', '.');

        if (isNaN(parseFloat(length)) || isNaN(parseFloat(width)) || isNaN(parseFloat(depth))) {
          errorElement.textContent = 'Please enter valid numbers for length, width, and depth.';
          errorElement.classList.remove('hidden');
          return;
        }

        const object = {
          name: document.getElementById('name').value,
          length: parseFloat(length),
          width: parseFloat(width),
          depth: parseFloat(depth),
          surface: document.getElementById('surface').value,
          location: document.getElementById('location').value
        };

        try {
          if (id) await axios.put(`${BASE_URL}/api/objects/${id}`, object);
          else await axios.post(`${BASE_URL}/api/objects`, object);
          form.reset();
          document.getElementById('edit-id').value = '';
          document.getElementById('form-title').textContent = 'Create New Object';
          errorElement.classList.add('hidden');
          showPage('storage');
        } catch (error) {
          console.error('Error saving object:', error);
          errorElement.textContent = 'Error saving object: ' + (error.response?.data?.error || error.message);
          errorElement.classList.remove('hidden');
        }
      });
    }

    document.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.getAttribute('onclick')?.match(/\d+/)?.[0];
        if (id) {
          if (e.target.textContent === 'Edit') editObject(id);
          else if (e.target.textContent === 'Delete') deleteObject(id);
          else if (e.target.textContent === 'QR') showQRCode(id);
        }
      });
    });

    document.querySelectorAll('nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        const page = btn.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
        if (page) showPage(page);
      });
    });
  }

  function showPage(page) {
    document.getElementById('new-or-edit-object').classList.add('hidden');
    document.getElementById('storage').classList.add('hidden');
    document.getElementById('login').classList.add('hidden');
    document.getElementById('register').classList.add('hidden');
    document.getElementById(page).classList.remove('hidden');
    if (page === 'new-or-edit-object') {
      const editId = document.getElementById('edit-id').value;
      document.getElementById('form-title').textContent = editId ? 'Edit Object' : 'Create New Object';
      document.getElementById('form-error').classList.add('hidden');
    }
  }

  async function renderObjects() {
    const filterName = document.getElementById('filter-name').value.toLowerCase();
    const filterLocation = document.getElementById('filter-location').value;
    const table = document.getElementById('object-table');
    table.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';

    try {
      const response = await axios.get(`${BASE_URL}/api/objects`);
      const objects = response.data;
      table.innerHTML = '';
      objects.forEach((obj) => {
        if (obj.name.toLowerCase().includes(filterName) && (!filterLocation || obj.location === filterLocation)) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><a href="${BASE_URL}/object/${obj.id}">${obj.name}</a></td>
            <td>${obj.length}</td>
            <td>${obj.width}</td>
            <td>${obj.depth}</td>
            <td>${obj.surface}</td>
            <td>${obj.location}</td>
            <td>
              <button class="action-btn">Edit</button>
              <button class="action-btn">Delete</button>
              <button class="action-btn">QR</button>
            </td>
          `;
          table.appendChild(row);
        }
      });
      attachEventListeners(); // Reattach listeners after rendering
    } catch (error) {
      console.error('Error fetching objects:', error);
      table.innerHTML = '<tr><td colspan="7">Error loading objects. Check console.</td></tr>';
    }
  }

  async function editObject(id) {
    try {
      const response = await axios.get(`${BASE_URL}/api/objects/${id}`);
      const obj = response.data;
      document.getElementById('name').value = obj.name;
      document.getElementById('length').value = obj.length;
      document.getElementById('width').value = obj.width;
      document.getElementById('depth').value = obj.depth;
      document.getElementById('surface').value = obj.surface;
      document.getElementById('location').value = obj.location;
      document.getElementById('edit-id').value = id;
      showPage('new-or-edit-object');
    } catch (error) {
      console.error('Error fetching object:', error);
    }
  }

  async function deleteObject(id) {
    if (confirm('Are you sure you want to delete this object?')) {
      try {
        await axios.delete(`${BASE_URL}/api/objects/${id}`);
        renderObjects();
      } catch (error) {
        console.error('Error deleting object:', error);
      }
    }
  }

  async function showQRCode(id) {
    try {
      const qrContent = `${BASE_URL}/object/${id}`;
      document.getElementById('qr-modal').classList.remove('hidden');
      const qrDiv = document.getElementById('qrcode');
      qrDiv.innerHTML = '';
      new QRCode(qrDiv, { text: qrContent, width: 200, height: 200 });
    } catch (error) {
      console.error('Error generating QR code:', error);
    }
  }

  function closeQRModal() {
    document.getElementById('qr-modal').classList.add('hidden');
  }

  function downloadQRCode() {
    const tempQR = document.querySelector('#qrcode canvas');
    const link = document.createElement('a');
    link.href = tempQR.toDataURL();
    link.download = 'object_qr.png';
    link.click();
  }

  function downloadQRCodeAsPDF() {
    const { jsPDF } = window.jspdf;
    const tempQR = document.querySelector('#qrcode canvas');
    const qrDataURL = tempQR.toDataURL();
    const pdf = new jsPDF();
    pdf.addImage(qrDataURL, 'PNG', 10, 10, 50, 50);
    pdf.save('object_qr.pdf');
  }
</script>

</body>
</html>
